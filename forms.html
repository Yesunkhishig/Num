<!DOCTYPE html>
<html lang="mn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Маягтууд - NumForms</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="navbar-content">
        <div class="logo">
          <a href="index.html">NumForms</a>
        </div>
        <div class="nav-links" id="navLinks">
          <a href="index.html" class="nav-link">Нүүр</a>
          <a href="forms.html" class="nav-link active">Маягтууд</a>
          <a href="directory.html" class="nav-link">Ажилчдын хаяг</a>
          <a href="about.html" class="nav-link">Бидний тухай</a>
        </div>
        <div class="nav-actions">
          <a href="notifications.html" class="icon-link notifications-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"></path>
            </svg>
            <span class="notification-badge" id="notificationBadge"></span>
          </a>
          <a href="profile.html" class="icon-link profile-link">
            <span class="profile-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </span>
            <span class="profile-name" id="profileName"></span>
          </a>
          <button id="logoutBtn" class="icon-button logout-button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
          </button>
        </div>
        <button class="mobile-menu-button" id="mobileMenuBtn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <div class="forms-container">
    <h1 id="formsTitle">Өргөдөл, маягт илгээх</h1>

    <div id="requestForm" class="request-form card">
      <form id="newRequestForm">
        <div class="form-group">
          <label class="form-label" for="title">Гарчиг</label>
          <input type="text" id="title" class="form-input" placeholder="Өргөдлийн гарчиг">
        </div>
        <div class="form-group">
          <label class="form-label" for="type">Төрөл</label>
          <select id="type" name="requestType" class="form-select" required>
            <option value="" disabled selected>Маягтын төрөл сонгох</option>
            <option value="r_rating_request">R үнэлгээний хүсэлт гаргах</option>
            <option value="grade_dispute_complaint">Дүнгийн маргаан, гомдол барагдуулах</option>
            <option value="late_registration">Хожимдсон бүртгэл хийлгэх</option>
            <option value="course_cancellation">Хичээл цуцлуулах</option>
            <option value="add_elective_course">Чөлөөт сонголтын хичээл нэмүүлэх</option>
            <option value="transfer_elective_course">Чөлөөт сонголтын хичэел шилжүүлэх маягт</option>
            <option value="minor_program_application">Хавсрага хөтөлбөрийн маягт</option>
            <option value="leave_of_absence_request">Суралцагчид чөлөө олгох хуудас</option>
            <option value="re_enrollment_request">Эргэн суралцах хүсэлтийн маягт</option>
            <option value="student_personal_plan">Суралцагчдын хувийн төлөвлөгөөний маягт</option>
            <option value="school_withdrawal_request">Суралцагч сургуулиас хасагдах хүсэлтийн маягт</option>
            <option value="dormitory_checkout_request">Байрнаас гарах хүсэлт</option>
            <option value="refund_request">Төлбөрийн буцаалт</option>
            <option value="unified_form_report">Нэгдсэн маягтын тайлан</option>
            <option value="custom_request">Өргөдөл</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="type">Өргөдлийн төрлийн тодорхойлолт</label>
          <p id="requestTypeDescription" class="form-description">
            Өргөдлийн төрлийг сонгоно уу.
          </p>
        </div>
        <div class="form-group">
          <label class="form-label">Өргөдлийн агуулга</label>
          <iframe
            id="jotFormIFrame"
            title="Request Form"
            onload="window.parent.scrollTo(0,0)"
            allowtransparency="true"
            allow="geolocation; microphone; camera; fullscreen"
            src="https://form.jotform.com/251119434684459"
            frameborder="0"
            style="min-width:100%;max-width:100%;height:739px;border:none;"
            scrolling="yes"
            class="hidden"
          ></iframe>
          <textarea id="description" class="form-textarea hidden" placeholder="Өргөдлийн агуулгыг энд бичих..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Өргөдөл илгээх</button>
        <div id="qrCodeSection" class="qr-code-container hidden">
          <h3>Таны өргөдлийн QR код</h3>
          <div class="qr-code-wrapper">
            <img id="qrCodeImage" src="" alt="QR Code" />
          </div>
          <p class="qr-instructions">Энэ QR кодыг хадгалаарай. Өргөдлийн төлөвийг хянах боломжтой.</p>
          <button id="downloadQrBtn" class="btn btn-secondary">QR кодыг татах</button>
        </div>
      </form>
    </div>

    <div class="request-tabs">
      <button class="request-tab active" data-tab="pending">
        Хүлээгдэж буй <span id="pendingCount"></span>
      </button>
      <button class="request-tab" data-tab="approved">
        Батлагдсан <span id="approvedCount"></span>
      </button>
      <button class="request-tab" data-tab="rejected">
        Татгалзсан <span id="rejectedCount"></span>
      </button>
    </div>

    <div class="request-panels">
      <div class="request-panel active" id="pendingPanel">
        <div class="request-list" id="pendingList"></div>
        <div class="empty-state hidden" id="emptyPending">
          <h3 class="empty-title">Хүлээгдэж буй өргөдөл байхгүй байна</h3>
        </div>
      </div>
      <div class="request-panel" id="approvedPanel">
        <div class="request-list" id="approvedList"></div>
        <div class="empty-state hidden" id="emptyApproved">
          <h3 class="empty-title">Батлагдсан өргөдөл байхгүй байна</h3>
        </div>
      </div>
      <div class="request-panel" id="rejectedPanel">
        <div class="request-list" id="rejectedList"></div>
        <div class="empty-state hidden" id="emptyRejected">
          <h3 class="empty-title">Татгалзсан өргөдөл байхгүй байна</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay hidden" id="requestModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="requestModalTitle">Өргөдөл</h3>
        <button class="modal-close" id="closeRequestModal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="commentText">Тайлбар</label>
          <textarea id="commentText" class="form-textarea" placeholder="Тайлбар бичих..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelModal">Цуцлах</button>
        <button class="btn btn-primary" id="saveComment">Хадгалах</button>
      </div>
    </div>
  </div>

  <script>
    // JotForm URLs for each request type (Replace with actual URLs)
    const jotFormUrls = {
      'r_rating_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'grade_dispute_complaint': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'late_registration': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'course_cancellation': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'add_elective_course': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'transfer_elective_course': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'minor_program_application': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'leave_of_absence_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      're_enrollment_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'student_personal_plan': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'school_withdrawal_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'dormitory_checkout_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'refund_request': 'https://form.jotform.com/251119434684459', // Replace with actual URL
      'unified_form_report': 'https://form.jotform.com/251119434684459' // Replace with actual URL
    };

    // Descriptions for each request type
    const requestTypeDescriptions = {
      'r_rating_request': 'R үнэлгээний хүсэлт нь таны сургалтын үнэлгээтэй холбоотой асуудлыг шийдвэрлэхэд чиглэнэ.',
      'grade_dispute_complaint': 'Дүнгийн маргаан, гомдолтой холбоотой асуудлыг шийдвэрлэх хүсэлт.',
      'late_registration': 'Хугацаа хожимдсон тохиолдолд бүртгэл хийлгэх хүсэлт.',
      'course_cancellation': 'Сонгосон хичээлийг цуцлах хүсэлт.',
      'add_elective_course': 'Чөлөөт сонголтын хичэел нэмэх хүсэлт.',
      'transfer_elective_course': 'Чөлөөт сонголтын хичээлийг өөр хичээлээр солих хүсэлт.',
      'minor_program_application': 'Хавсрага хөтөлбөрт хамрагдах хүсэлт.',
      'leave_of_absence_request': 'Суралцагчид түр хугацаагаар чөлөө авах хүсэлт.',
      're_enrollment_request': 'Сургуульдаа эргэн суралцах хүсэлт.',
      'student_personal_plan': 'Суралцагчийн хувийн сургалтын төлөвлөгөөний хүсэлт.',
      'school_withdrawal_request': 'Сургуулиас гарах хүсэлт.',
      'dormitory_checkout_request': 'Оюутны байрнаас гарах хүсэлт.',
      'refund_request': 'Төлбөрийн буцаалт хүсэх.',
      'unified_form_report': 'Нэгдсэн маягтын тайлангийн хүсэлт.',
      'custom_request': 'Өөрөө бичиж оруулах өргөдлийн хүсэлт.'
    };

    // Get DOM elements
    const typeSelect = document.getElementById('type');
    const jotFormIFrame = document.getElementById('jotFormIFrame');
    const descriptionTextarea = document.getElementById('description');
    const requestTypeDescription = document.getElementById('requestTypeDescription');

    // Function to update form based on selected type
    function updateForm() {
      const selectedType = typeSelect.value;
      if (selectedType === 'custom_request') {
        jotFormIFrame.classList.add('hidden');
        descriptionTextarea.classList.remove('hidden');
      } else if (selectedType) {
        jotFormIFrame.classList.remove('hidden');
        descriptionTextarea.classList.add('hidden');
        jotFormIFrame.src = jotFormUrls[selectedType] || 'https://form.jotform.com/251119434684459';
      } else {
        jotFormIFrame.classList.add('hidden');
        descriptionTextarea.classList.add('hidden');
      }
      requestTypeDescription.textContent = selectedType && requestTypeDescriptions[selectedType]
        ? requestTypeDescriptions[selectedType]
        : 'Өргөдлийн төрлийг сонгоно уу.';
    }

    // Event listener for type selection change
    typeSelect.addEventListener('change', updateForm);

    // Initialize form on page load
    updateForm();

    // Forms Page JavaScript
    let currentUser = null;
    let userRequests = [];
    let allRequests = [];
    let userNotifications = [];
    let currentRequestId = null;
    let currentAction = null;

    const REQUEST_TYPES = {
      'r_rating_request': 'R үнэлгээний хүсэлт гаргах',
      'grade_dispute_complaint': 'Дүнгийн маргаан, гомдол барагдуулах',
      'late_registration': 'Хожимдсон бүртгэл хийлгэх',
      'course_cancellation': 'Хичээл цуцлуулах',
      'add_elective_course': 'Чөлөөт сонголтын хичэел нэмүүлэх',
      'transfer_elective_course': 'Чөлөөт сонголтын хичэел шилжүүлэх маягт',
      'minor_program_application': 'Хавсрага хөтөлбөрийн маягт',
      'leave_of_absence_request': 'Суралцагчид чөлөө олгох хуудас',
      're_enrollment_request': 'Эргэн суралцах хүсэлтийн маягт',
      'student_personal_plan': 'Суралцагчдын хувийн төлөвлөгөөний маягт',
      'school_withdrawal_request': 'Суралцагч сургуулиас хасагдах хүсэлтийн маягт',
      'dormitory_checkout_request': 'Байрнаас гарах хүсэлт',
      'refund_request': 'Төлбөрийн буцаалт',
      'unified_form_report': 'Нэгдсэн маягтын тайлан',
      'custom_request': 'Өргөдөл'
    };

    function initFormsPage() {
      const storedUser = localStorage.getItem("numforms_user");
      if (storedUser) {
        try {
          currentUser = JSON.parse(storedUser);
          loadData();
          updateUI();
          setupEventListeners();
        } catch (error) {
          console.error("Failed to parse stored user:", error);
          localStorage.removeItem("numforms_user");
          window.location.href = "index.html";
        }
      } else {
        window.location.href = "index.html";
      }
    }

    function loadData() {
      const storedRequests = localStorage.getItem("numforms_requests");
      if (storedRequests) {
        try {
          allRequests = JSON.parse(storedRequests);
          if (currentUser.userType === "student") {
            userRequests = allRequests.filter(req => req.userId === currentUser.id);
          } else {
            userRequests = [...allRequests];
          }
        } catch (error) {
          console.error("Failed to parse stored requests:", error);
          allRequests = [];
          userRequests = [];
        }
      } else {
        allRequests = [];
        userRequests = [];
      }

      const storedNotifications = localStorage.getItem(`numforms_notifications_${currentUser.id}`);
      if (storedNotifications) {
        try {
          userNotifications = JSON.parse(storedNotifications);
        } catch (error) {
          console.error("Failed to parse stored notifications:", error);
          userNotifications = [];
        }
      } else {
        userNotifications = [];
      }
    }

    function updateUI() {
      const profileName = document.getElementById("profileName");
      if (profileName) {
        profileName.textContent = currentUser.firstName;
      }

      updateNotificationBadge();

      const isStudent = currentUser.userType === "student";
      document.getElementById("formsTitle").textContent = isStudent 
        ? "Өргөдөл, маягт илгээх" 
        : "Өргөдөл, хүсэлт хянах";
      document.getElementById("requestForm").style.display = isStudent ? "block" : "none";

      const pendingRequests = userRequests.filter(req => req.status === "pending");
      const approvedRequests = userRequests.filter(req => req.status === "approved");
      const rejectedRequests = userRequests.filter(req => req.status === "rejected");

      document.getElementById("pendingCount").textContent = pendingRequests.length > 0 ? `(${pendingRequests.length})` : "";
      document.getElementById("approvedCount").textContent = approvedRequests.length > 0 ? `(${approvedRequests.length})` : "";
      document.getElementById("rejectedCount").textContent = rejectedRequests.length > 0 ? `(${rejectedRequests.length})` : "";

      updateRequestList("pending", pendingRequests);
      updateRequestList("approved", approvedRequests);
      updateRequestList("rejected", rejectedRequests);
    }

    function updateRequestList(status, requests) {
      const listElement = document.getElementById(`${status}List`);
      const emptyElement = document.getElementById(`empty${status.charAt(0).toUpperCase() + status.slice(1)}`);

      if (requests.length === 0) {
        listElement.classList.add("hidden");
        emptyElement.classList.remove("hidden");
        return;
      }

      listElement.classList.remove("hidden");
      emptyElement.classList.add("hidden");

      const sortedRequests = [...requests].sort((a, b) => {
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      listElement.innerHTML = "";

      sortedRequests.forEach(request => {
        const requestElement = document.createElement("div");
        requestElement.className = "request-item";
        requestElement.setAttribute("data-id", request.id);

        const date = new Date(request.createdAt);
        const formattedDate = date.toLocaleDateString("mn-MN");
        const requestTypeLabel = REQUEST_TYPES[request.type] || request.type;

        requestElement.innerHTML = `
          <div class="request-header">
            <div>
              <h3 class="request-title">${request.title}</h3>
              <p class="request-meta">
                ${currentUser.userType === "staff" ? `Оюутны дугаар: ${request.userId} •` : `Төрөл: ${requestTypeLabel} •`} 
                ${request.formUrl ? `<a href="${request.formUrl}" target="_blank" class="form-link">Форм харах</a> • ` : ''} 
                Огноо: ${formattedDate}
              </p>
            </div>
            <span class="request-status status-${request.status}">
              ${getStatusLabel(request.status)}
            </span>
          </div>
          <div class="request-body">
            ${request.description ? `<p class="request-description">${request.description}</p>` : ''}
            ${request.formUrl ? `<p class="request-form-link">Форм: <a href="${request.formUrl}" target="_blank" class="form-link">Харах</a></p>` : ''}
            ${request.comments && request.comments.length > 0 ? `
              <div class="request-comments">
                <h4 class="comment-title">Тайлбар:</h4>
                <div class="comment-list">
                  ${request.comments.map(comment => `
                    <div class="comment-item">
                      <div class="comment-header">
                        <span class="comment-author">
                          ${comment.userFullName} (${comment.userType === "student" ? "Оюутан" : "Ажилтан"})
                        </span>
                        <span class="comment-date">
                          ${new Date(comment.createdAt).toLocaleString("mn-MN")}
                        </span>
                      </div>
                      <p>${comment.content}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="request-actions">
            ${getRequestActions(request)}
          </div>
        `;

        listElement.appendChild(requestElement);

        // Add event listeners only for staff actions
        if (currentUser.userType === "staff") {
          const commentBtns = requestElement.querySelectorAll(".comment-btn");
          commentBtns.forEach(btn => {
            btn.addEventListener("click", () => openCommentModal(request.id));
          });

          const approveBtns = requestElement.querySelectorAll(".approve-btn");
          approveBtns.forEach(btn => {
            btn.addEventListener("click", () => openActionModal(request.id, "approve"));
          });

          const rejectBtns = requestElement.querySelectorAll(".reject-btn");
          rejectBtns.forEach(btn => {
            btn.addEventListener("click", () => openActionModal(request.id, "reject"));
          });
        }

        // Add error handling for form links
        const formLinks = requestElement.querySelectorAll(".form-link");
        formLinks.forEach(link => {
          link.addEventListener("click", async (e) => {
            try {
              const response = await fetch(link.href, { method: 'HEAD', mode: 'no-cors' });
              if (!response.ok) {
                e.preventDefault();
                showToast("Алдаа", "Форм хандах боломжгүй байна. Админтай холбогдоно уу.", "error");
              }
            } catch (error) {
              e.preventDefault();
              showToast("Алдаа", "Форм хандах боломжгүй байна: Сервертэй холбогдох боломжгүй.", "error");
              console.error("Form link check failed:", error);
            }
          });
        });
      });
    }

    function getStatusLabel(status) {
      switch (status) {
        case "pending": return "Хүлээгдэж байна";
        case "approved": return "Батлагдсан";
        case "rejected": return "Татгалзсан";
        default: return "Тодорхойгүй";
      }
    }

    function getRequestActions(request) {
      const isStaff = currentUser.userType === "staff";
      const isPending = request.status === "pending";

      if (isStaff && isPending) {
        return `
          <button class="btn btn-danger reject-btn">Татгалзах</button>
          <div>
            <button class="btn btn-outline comment-btn">Тайлбар нэмэх</button>
            <button class="btn btn-success approve-btn">Зөвшөөрөх</button>
          </div>
        `;
      } else {
        return ''; // No actions for students
      }
    }

    function setupEventListeners() {
      const requestForm = document.getElementById("newRequestForm");
      if (requestForm) {
        requestForm.addEventListener("submit", handleRequestSubmit);
      }

      const tabButtons = document.querySelectorAll(".request-tab");
      console.log("Found tab buttons:", tabButtons.length);
      tabButtons.forEach(btn => {
        btn.addEventListener("click", function() {
          const tabId = this.getAttribute("data-tab");
          console.log("Tab clicked:", tabId);

          document.querySelectorAll(".request-tab").forEach(b => b.classList.remove("active"));
          document.querySelectorAll(".request-panel").forEach(p => p.classList.remove("active"));

          this.classList.add("active");
          const panel = document.getElementById(`${tabId}Panel`);
          if (panel) {
            panel.classList.add("active");
            console.log("Switched to panel:", `${tabId}Panel`);
          } else {
            console.error("Panel not found:", `${tabId}Panel`);
          }
        });
      });

      if (currentUser && currentUser.userType === "staff") {
        document.getElementById("closeRequestModal").addEventListener("click", closeModal);
        document.getElementById("cancelModal").addEventListener("click", closeModal);
        document.getElementById("saveComment").addEventListener("click", handleSaveComment);
      }

      const mobileMenuBtn = document.getElementById("mobileMenuBtn");
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener("click", toggleMobileMenu);
      }

      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", handleLogout);
      }
    }

    function handleRequestSubmit(e) {
      e.preventDefault();

      const title = document.getElementById("title").value.trim();
      const type = document.getElementById("type").value;

      if (!title || !type) {
        showToast("Алдаа", "Гарчиг болон төрлийг бөглөнө үү", "error");
        return;
      }

      let description = "";
      let formUrl = "";

      if (type === "custom_request") {
        description = document.getElementById("description").value.trim();
        if (!description) {
          showToast("Алдаа", "Өргөдлийн агуулгыг бөглөнө үү", "error");
          return;
        }
      } else {
        // Use the JotForm URL for the selected type
        formUrl = jotFormUrls[type] || `https://form.jotform.com/251119434684459`;
      }

      const now = new Date().toISOString();
      const newRequest = {
        id: `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        userId: currentUser.id,
        title,
        description: description || null,
        formUrl: formUrl || null,
        status: "pending",
        createdAt: now,
        updatedAt: now,
        comments: [],
        type
      };

      allRequests.push(newRequest);
      localStorage.setItem("numforms_requests", JSON.stringify(allRequests));

      generateQRCode(newRequest);

      addNotification({
        userId: "STAFF001",
        title: "Шинэ өргөдөл",
        message: `${currentUser.firstName} оюутан шинээр өргөдөл илгээлээ`,
        isRead: false,
        relatedTo: {
          type: "request",
          id: newRequest.id
        }
      });

      document.getElementById("newRequestForm").reset();

      loadData();
      updateUI();

      showToast("Амжилттай", "Таны өргөдөл амжилттай илгээгдлээ");
      document.getElementById('qrCodeSection').scrollIntoView({ behavior: 'smooth' });
    }

    function openCommentModal(requestId) {
      if (currentUser.userType !== "staff") {
        console.log("Commenting is restricted to staff only");
        return;
      }
      currentRequestId = requestId;
      currentAction = "comment";
      document.getElementById("requestModalTitle").textContent = "Тайлбар нэмэх";
      document.getElementById("commentText").value = "";
      document.getElementById("requestModal").classList.remove("hidden");
    }

    function openActionModal(requestId, action) {
      if (currentUser.userType !== "staff") {
        console.log("Actions are restricted to staff only");
        return;
      }
      currentRequestId = requestId;
      currentAction = action;
      document.getElementById("requestModalTitle").textContent = action === "approve" ? "Өргөдөл батлах" : "Өргөдөл татгалзах";
      document.getElementById("commentText").value = "";
      document.getElementById("requestModal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("requestModal").classList.add("hidden");
      currentRequestId = null;
      currentAction = null;
    }

    function handleSaveComment() {
      if (currentUser.userType !== "staff") {
        console.log("Comment saving is restricted to staff only");
        return;
      }

      const commentText = document.getElementById("commentText").value.trim();

      if (!commentText) {
        showToast("Алдаа", "Тайлбар хоосон байж болохгүй", "error");
        return;
      }

      const requestIndex = allRequests.findIndex(req => req.id === currentRequestId);
      if (requestIndex === -1) {
        showToast("Алдаа", "Өргөдөл олдсонгүй", "error");
        closeModal();
        return;
      }

      const comment = {
        id: `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        requestId: currentRequestId,
        userId: currentUser.id,
        userFullName: `${currentUser.firstName} ${currentUser.lastName || ''}`,
        userType: currentUser.userType,
        content: commentText,
        createdAt: new Date().toISOString()
      };

      if (!allRequests[requestIndex].comments) {
        allRequests[requestIndex].comments = [];
      }

      allRequests[requestIndex].comments.push(comment);

      if (currentAction === "approve") {
        allRequests[requestIndex].status = "approved";
        allRequests[requestIndex].updatedAt = new Date().toISOString();
      } else if (currentAction === "reject") {
        allRequests[requestIndex].status = "rejected";
        allRequests[requestIndex].updatedAt = new Date().toISOString();
      }

      localStorage.setItem("numforms_requests", JSON.stringify(allRequests));

      const request = allRequests[requestIndex];
      const notifyUserId = request.userId;
      let notificationTitle = "Тайлбар нэмэгдлээ";
      let notificationMessage = `Таны өргөдөлд ${currentUser.firstName} багш тайлбар нэмлээ`;

      if (currentAction === "approve") {
        notificationTitle = "Өргөдөл батлагдлаа";
        notificationMessage = `Таны '${request.title}' батлагдлаа`;
      } else if (currentAction === "reject") {
        notificationTitle = "Өргөдөл татгалзлаа";
        notificationMessage = `Таны '${request.title}' татгалзлаа`;
      }

      addNotification({
        userId: notifyUserId,
        title: notificationTitle,
        message: notificationMessage,
        isRead: false,
        relatedTo: {
          type: "request",
          id: request.id
        }
      });

      closeModal();
      loadData();
      updateUI();

      showToast("Амжилттай", currentAction === "comment" ? "Тайлбар нэмэгдлээ" : 
                currentAction === "approve" ? "Өргөдөл батлагдлаа" : "Өргөдөл татгалзлаа");
    }

    function addNotification(notification) {
      const storedNotifications = localStorage.getItem(`numforms_notifications_${notification.userId}`);
      let userNotifs = [];

      if (storedNotifications) {
        try {
          userNotifs = JSON.parse(storedNotifications);
        } catch (error) {
          console.error("Failed to parse stored notifications:", error);
          userNotifs = [];
        }
      }

      const newNotification = {
        ...notification,
        id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        createdAt: new Date().toISOString()
      };

      userNotifs.unshift(newNotification);
      localStorage.setItem(`numforms_notifications_${notification.userId}`, JSON.stringify(userNotifs));

      if (notification.userId === currentUser.id) {
        loadData();
        updateNotificationBadge();
      }
    }

    function updateNotificationBadge() {
      const badge = document.getElementById("notificationBadge");
      if (badge) {
        const unreadCount = userNotifications.filter(n => !n.isRead).length;
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? "flex" : "none";
      }
    }

    function toggleMobileMenu() {
      const navLinks = document.getElementById("navLinks");
      navLinks.classList.toggle("active");
    }

    function handleLogout() {
      localStorage.removeItem("numforms_user");
      window.location.href = "index.html";
    }

    function showToast(title, message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type} fade-in`;

      toast.innerHTML = `
        <div class="toast-header">${title}</div>
        <div class="toast-body">${message}</div>
      `;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.classList.remove("fade-in");
        toast.classList.add("fade-out");
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    function generateQRCode(formData) {
      try {
        const qrCodeSection = document.getElementById('qrCodeSection');
        qrCodeSection.classList.remove('hidden');
        qrCodeSection.innerHTML = '<p class="loading">QR код үүсгэж байна...</p>';

        const baseUrl = window.location.origin;
        const viewUrl = `${baseUrl}/view-submission.html?id=${encodeURIComponent(formData.id)}`;
        const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(viewUrl)}&size=200x200&format=png&margin=10`;

        qrCodeSection.innerHTML = `
          <h3>Таны өргөдлийн QR код</h3>
          <div class="qr-code-wrapper">
            <img id="qrCodeImage" src="${qrApiUrl}" alt="QR Code" />
          </div>
          <p class="qr-instructions">Энэ QR кодыг хадгалаарай. Өргөдлийн төлөвийг хянах боломжтой.</p>
          <button id="downloadQrBtn" class="btn btn-secondary">QR кодыг татах</button>
        `;

        const newQrCodeImage = document.getElementById('qrCodeImage');
        const newDownloadBtn = document.getElementById('downloadQrBtn');

        newQrCodeImage.onload = () => {
          newDownloadBtn.disabled = false;
        };

        newQrCodeImage.onerror = () => {
          qrCodeSection.innerHTML = '<p class="error">QR код үүсгэхэд алдаа гарлаа. Дахин оролдоно уу.</p>';
          console.error("Failed to load QR code image");
        };

        newDownloadBtn.addEventListener('click', () => {
          downloadQRCode(qrApiUrl, `numforms-submission-${formData.id}.png`);
        });

        return viewUrl;
      } catch (error) {
        console.error("QR code generation failed:", error);
        document.getElementById('qrCodeSection').innerHTML = '<p class="error">QR код үүсгэхэд алдаа гарлаа.</p>';
        return null;
      }
    }

    async function downloadQRCode(src, filename) {
      try {
        const response = await fetch(src);
        if (!response.ok) {
          throw new Error('Failed to fetch QR code image');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error("Failed to download QR code:", error);
        showToast("Алдаа", "QR кодыг татахад алдаа гарлаа", "error");
      }
    }

    const style = document.createElement("style");
    style.textContent = `
      .toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        min-width: 250px;
        max-width: 350px;
        background-color: var(--primary-color);
        color: white;
        border-radius: var(--radius);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        overflow: hidden;
      }
      .toast.success {
        background-color: var(--success);
      }
      .toast.error {
        background-color: var(--error);
      }
      .toast-header {
        padding: 0.5rem 1rem;
        font-weight: 600;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }
      .toast-body {
        padding: 0.75rem 1rem;
      }
      .ml-auto {
        margin-left: auto;
      }
      .form-link {
        color: var(--primary-color, #007bff);
        text-decoration: underline;
        cursor: pointer;
      }
      .form-link:hover {
        color: var(--primary-dark, #0056b3);
      }
    `;
    document.head.appendChild(style);

    document.addEventListener("DOMContentLoaded", initFormsPage);
  </script>
</body>
</html>